#!/bin/bash

# Copyright (C) 2018 Matthew Marting
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -e -o pipefail

source libsudo.sh

source libtlogger.sh

readonly TTY_LOGGER_LOCK_BASENAME='.lock'
readonly TTY_LOGGER_LOCK_PATH="$TTY_LOGGER_DIRECTORY"`
                             `'/'`
                             `"$TTY_LOGGER_LOCK_BASENAME"
readonly TTY_LOG_PATH="$TTY_LOGGER_DIRECTORY"`
                     `'/'`
                     `"$TTY_LOG_BASENAME_VERSION_HEAD"`
                     `"$TTY_LOG_BASENAME_DELIMITER"`
                     `"$TTY_LOG_EXT"

sudo::the_home_is_the_user_home_or_die
install -d "$TTY_LOGGER_DIRECTORY"

{
  if [[ -e $TTY_LOG_PATH ]]; then
    tty_log_path="$TTY_LOG_PATH_VERSION_HEAD"`
                `"$(($(
      tlogger::get_the_tty_log_versions \
        | sort --numeric-sort --reverse \
        | head --lines=1) + 1))"`
                `"$TTY_LOG_PATH_VERSION_TAIL"
  else
    tty_log_path="$TTY_LOG_PATH"
  fi

  exec 4> "$tty_log_path"
} 3> "$TTY_LOGGER_LOCK_PATH"

args="${*@Q}"
echo "$args" >&4
exec 4>&-
script --append --command "$args" --return --quiet "$tty_log_path"
