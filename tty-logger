#!/bin/bash

# Copyright (C) 2018 Matthew Marting
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -e -o pipefail

source libtlogger.sh

readonly TTY_LOGGER_LOCK_BASENAME='.lock'
readonly TTY_LOGGER_LOCK_PATH="$TTY_LOGGER_DIRECTORY"`
                             `'/'`
                             `"$TTY_LOGGER_LOCK_BASENAME"
readonly TTY_LOG_PATH="$TTY_LOGGER_DIRECTORY"`
                     `'/'`
                     `"$TTY_LOG_BASENAME_VERSION_HEAD"`
                     `"$TTY_LOG_BASENAME_DELIMITER"`
                     `"$TTY_LOG_EXT"

install -d "$TTY_LOGGER_DIRECTORY"
{
  if [[ -e $TTY_LOG_PATH ]]; then
    exec 3> "$TTY_LOG_PATH_VERSION_HEAD"`
           `"$(($(
      tlogger::get_the_tty_log_versions \
        | sort --numeric-sort --reverse \
        | head --lines=1) + 1))"`
           `"$TTY_LOG_PATH_VERSION_TAIL"
  else
    exec 3> "$TTY_LOG_PATH"
  fi
} 4> "$TTY_LOGGER_LOCK_PATH"
_date_format='+%Y-%m-%dT%H:%M:%S%:z'

_format () {
    while IFS= read -r x
    do printf "%s %s%s%s\n" "$(date "$_date_format")" "$1" "$x" "$2"
    done
}

date "$_date_format" >&3
echo "$@" >&3
{ { { { { {
    "$@"|tee /dev/stderr 2>&4
} 2>&1 >&6|tee /dev/stderr 2>&5
} >&7
} 6>&1|_format >&3
} 7>&1|_format '[1;41m' '[0m' >&3
} 4>&1
} 5>&2
